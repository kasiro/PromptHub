<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prompt Hub</title>
    
    <!-- Tailwind CSS v4 -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- FontAwesome for Icons (No inline SVGs) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style type="text/tailwindcss">
        @variant dark (&:where(.dark, .dark *));
        @theme {
            --color-primary: var(--primary-color);
        }
    </style>
    <style>
      @media (max-width: 767px) {
          .computer-row { display: flex; flex-direction: column; align-items: stretch; gap: 0.75rem; }
          .computer-row .computer-actions { margin-left: 0; display:flex; justify-content: flex-end; }
      }
    </style>

    <style>
        :root {
            --primary-color: #2563eb; /* Default Blue */
        }

        /* Custom Scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #525252; 
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.2s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        /* Safe area for mobile bottom nav */
        /* Increased padding to prevent bottom nav from covering content on mobile */
        .safe-bottom {
            padding-bottom: calc(6rem + env(safe-area-inset-bottom));
        }
        
        @media (min-width: 768px) {
            .safe-bottom {
                padding-bottom: 2rem;
            }
        }

        /* Modal performance: isolate layout, reduce repaints */
        .modal-content {
            contain: layout style paint;
        }
    </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100 transition-colors duration-300 select-none font-sans antialiased md:overflow-hidden">
    <div id="app" class="min-h-screen md:h-screen w-full flex flex-col md:flex-row md:overflow-hidden">
        
        <!-- DESKTOP SIDEBAR (Hidden on Mobile) -->
        <aside class="hidden md:flex w-72 flex-col bg-white dark:bg-neutral-800 border-r border-neutral-200 dark:border-neutral-700 z-30 transition-colors sticky top-0 h-screen">
            <!-- Branding -->
            <div class="p-6 border-b border-neutral-100 dark:border-neutral-700/50">
                <h1 class="text-2xl font-bold text-neutral-900 dark:text-white flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/30">
                        <i class="fa-solid fa-bolt text-sm"></i>
                    </div>
                    Prompt Hub
                </h1>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button
                    style="cursor: pointer;"
                    @click="currentTab = 'home'"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all group"
                    :class="currentTab === 'home' ? 'bg-primary/10 text-primary font-semibold' : 'text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-700 hover:text-neutral-900 dark:hover:text-white'"
                >
                    <i class="fa-solid fa-house w-6 text-center"></i>
                    <span>Главная</span>
                </button>
                
                <button
                    style="cursor: pointer;"
                    @click="currentTab = 'categories'"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all group"
                    :class="currentTab === 'categories' ? 'bg-primary/10 text-primary font-semibold' : 'text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-700 hover:text-neutral-900 dark:hover:text-white'"
                >
                    <i class="fa-solid fa-layer-group w-6 text-center"></i>
                    <span>Категории</span>
                    <span class="ml-auto text-white text-xs bg-neutral-200 dark:bg-neutral-700 px-2 py-0.5 rounded-full group-hover:bg-white dark:group-hover:bg-neutral-600 transition-colors">
                        {{ categories.length }}
                    </span>
                </button>
                
                <button
                    style="cursor: pointer;" 
                    @click="currentTab = 'settings'"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all group"
                    :class="currentTab === 'settings' ? 'bg-primary/10 text-primary font-semibold' : 'text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-700 hover:text-neutral-900 dark:hover:text-white'"
                >
                    <i class="fa-solid fa-gear w-6 text-center"></i>
                    <span>Настройки</span>
                </button>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-neutral-100 dark:border-neutral-700/50">
                <div class="bg-neutral-50 dark:bg-neutral-900 rounded-xl p-4 flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-neutral-200 dark:bg-neutral-700 flex items-center justify-center text-neutral-500">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <div class="text-sm font-bold text-neutral-900 dark:text-white truncate">Мои Промпты</div>
                        <div class="text-xs text-neutral-500 truncate">{{ prompts.length }} сохранено</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="flex-1 flex flex-col min-h-screen md:h-full relative md:overflow-hidden bg-neutral-50 dark:bg-neutral-900 transition-colors">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-white/80 dark:bg-neutral-800/80 backdrop-blur-md relative z-10 border-b border-neutral-200 dark:border-neutral-700 px-4 py-3 shadow-sm shrink-0">
                <div class="flex justify-between items-center w-full">
                    <h1 class="text-xl font-bold text-neutral-900 dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-primary"></i>
                        Prompt Hub
                    </h1>
                    <div class="text-xs font-medium px-2 py-1 rounded-full bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-300">
                        {{ prompts.length }} Промптов
                    </div>
                </div>
            </header>
            
            <!-- Desktop Header (Search/Tools) -->
            <header class="hidden md:flex justify-between items-center px-8 py-4 border-b border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 shrink-0">
                <h2 class="text-xl font-bold text-neutral-900 dark:text-white">
                    {{ 
                        currentTab === 'home' ? 'Библиотека' : 
                        currentTab === 'categories' ? 'Управление категориями' : 
                        'Настройки приложения' 
                    }}
                </h2>
                <div class="flex items-center space-x-4">
                     <button @click="toggleTheme" class="w-10 h-10 rounded-full bg-neutral-100 dark:bg-neutral-700 flex items-center justify-center text-neutral-600 dark:text-neutral-300 hover:bg-neutral-200 dark:hover:bg-neutral-600 transition-colors cursor-pointer shrink-0">
                        <i class="fa-solid" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                </div>
            </header>

            <!-- Main Scrollable Area -->
            <main class="flex-1 md:overflow-y-auto w-full p-4 md:p-8 safe-bottom">
                <div class="max-w-3xl mx-auto lg:max-w-full md:max-w-5xl md:mx-0 w-full space-y-6">
                
                    <!-- HOME TAB -->
                    <div v-if="currentTab === 'home'" class="space-y-6 animate-fade-in">
                        
                        <!-- Search + Add Button -->
                        <div class="flex gap-3 items-stretch">
                            <div class="relative group flex-1">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-search text-neutral-400 group-focus-within:text-primary transition-colors text-lg"></i>
                                </div>

                                <input 
                                    v-model="searchQuery"
                                    type="text" 
                                    placeholder="Поиск промптов по названию, тексту или категории..." 
                                    class="block w-full pl-12 pr-4 py-4 border border-neutral-200 dark:border-neutral-700 rounded-2xl leading-5 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm text-base"
                                >
                            </div>
                            <button 
                                @click="isAddPromptModalOpen = true" 
                                class="shrink-0 px-5 py-4 bg-primary hover:brightness-90 text-white rounded-2xl font-medium shadow-md shadow-primary/20 active:scale-95 transition-all flex items-center gap-2 cursor-pointer border border-transparent focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-neutral-900"
                            >
                                <i class="fa-solid fa-plus"></i>
                                <span class="hidden sm:inline">Новый промпт</span>
                            </button>
                        </div>

                        <div class="space-y-3 w-full">
                            
                            <!-- Prompts List -->
                            <div class="space-y-3 w-full">
                                <h3 class="text-sm font-medium text-neutral-500 uppercase tracking-wider ml-1 flex justify-between items-center">
                                    <span>{{ searchQuery ? 'Результаты поиска' : 'Все промпты' }}</span>
                                    <span class="text-xs normal-case bg-neutral-200 dark:bg-neutral-700 px-2 py-0.5 rounded text-neutral-600 dark:text-neutral-300">{{ filteredPrompts.length }} шт.</span>
                                </h3>

                                <div v-if="filteredPrompts.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div 
                                        v-for="prompt in filteredPrompts" 
                                        :key="prompt.id"
                                        @click="openPrompt(prompt)"
                                        class="bg-white dark:bg-neutral-800 p-5 rounded-xl border border-neutral-100 dark:border-neutral-700 shadow-sm hover:shadow-md hover:border-primary/30 dark:hover:border-primary/50 cursor-pointer flex flex-col justify-between h-full group transition-all duration-200"
                                    >
                                        <div class="overflow-hidden mb-3">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-bold text-neutral-800 dark:text-neutral-100 truncate pr-2 group-hover:text-primary transition-colors">{{ prompt.title }}</h4>
                                                <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-neutral-100 dark:bg-neutral-700 text-neutral-500 dark:text-neutral-400 shrink-0">
                                                    {{ getCategoryName(prompt.categoryId) }}
                                                </span>
                                            </div>
                                            <p class="text-sm text-neutral-500 dark:text-neutral-400 line-clamp-3 leading-relaxed">{{ prompt.text }}</p>
                                        </div>
                                        <div class="flex justify-between items-center pt-3 border-t border-neutral-50 dark:border-neutral-700 mt-auto">
                                            <span class="text-xs text-neutral-400">Нажмите для просмотра</span>
                                            <i class="fa-solid fa-chevron-right text-neutral-300 group-hover:translate-x-1 transition-transform"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else class="bg-white dark:bg-neutral-800 rounded-2xl p-10 text-center border border-neutral-100 dark:border-neutral-700">
                                    <div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-700 rounded-full flex items-center justify-center mx-auto mb-4 text-neutral-300 dark:text-neutral-500">
                                        <i class="fa-solid fa-folder-open text-3xl"></i>
                                    </div>
                                    <h3 class="text-lg font-medium text-neutral-900 dark:text-white mb-1">Ничего не найдено</h3>
                                    <p class="text-neutral-500 dark:text-neutral-400 text-sm">Попробуйте изменить поисковый запрос или добавьте новый промпт.</p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- CATEGORIES TAB -->
                    <div v-if="currentTab === 'categories'" class="space-y-4 max-w-4xl lg:max-w-full">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h2 class="text-2xl font-bold text-neutral-900 dark:text-white md:hidden">Категории</h2>
                        </div>
                        
                        <div v-if="categories.length === 0" class="text-center py-20 bg-white dark:bg-neutral-800 rounded-2xl border border-dashed border-neutral-300 dark:border-neutral-700">
                            <p class="text-neutral-500 dark:text-neutral-400">Нет категорий. Создайте их в настройках.</p>
                        </div>

                        <!-- Fixed Desktop Layout: Added items-start to prevent rows from expanding together -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start">
                            <div v-for="cat in categories" :key="cat.id" class="bg-white dark:bg-neutral-800 rounded-2xl overflow-hidden shadow-sm border border-neutral-100 dark:border-neutral-700 flex flex-col">
                                <!-- Category Header -->
                                <div
                                    @click="toggleCategory(cat.id)"
                                    class="p-4 flex justify-between items-center cursor-pointer dark:bg-neutral-800 dark:hover:bg-neutral-750 transition-colors border-b border-transparent"
                                    >
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                                            <i class="fa-solid fa-folder"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-neutral-900 dark:text-white">{{ cat.name }}</div>
                                            <div class="text-xs text-neutral-500">{{ getPromptsCount(cat.id) }} элементов</div>
                                        </div>
                                    </div>
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors">
                                        <i 
                                            class="fa-solid fa-chevron-down transition-transform duration-300 text-neutral-400"
                                            :class="{ 'rotate-180': expandedCategories.includes(cat.id) }"
                                        ></i>
                                    </div>
                                </div>

                                <!-- Prompts List in Category -->
                                <div 
                                    v-show="expandedCategories.includes(cat.id)"
                                    class="bg-white dark:bg-neutral-800 max-h-60 overflow-y-auto"
                                >
                                    <div v-if="getPromptsByCategory(cat.id).length === 0" class="p-6 text-center text-neutral-400 text-sm italic">
                                        В этой категории пока пусто
                                    </div>
                                    <div 
                                        v-for="prompt in getPromptsByCategory(cat.id)" 
                                        :key="prompt.id"
                                        class="p-3 mx-2 my-1 rounded-lg dark:hover:bg-neutral-750 transition-colors cursor-pointer group flex justify-between items-center"
                                        @click="openPrompt(prompt)"
                                    >
                                        <div class="flex-1 min-w-0 pr-3">
                                            <h4 class="text-sm font-semibold group-hover:text-primary transition-colors text-neutral-800 dark:text-neutral-200 truncate">{{ prompt.title }}</h4>
                                            <p class="text-xs text-neutral-500 truncate opacity-80">{{ prompt.text }}</p>
                                        </div>
                                        <button class="text-neutral-300 hover:text-primary transition-colors px-2">
                                            <i class="fa-regular fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="h-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS TAB -->
                    <div v-if="currentTab === 'settings'" class="space-y-6 lg:space-x-6 lg:grid lg:grid-cols-2 max-w-2xl lg:max-w-full">
                        <h2 class="text-2xl font-bold px-1 text-neutral-900 dark:text-white md:hidden">Настройки</h2>

                        <!-- Appearance -->
                        <div class="bg-white dark:bg-neutral-800 rounded-2xl p-6 shadow-sm border border-neutral-100 dark:border-neutral-700 space-y-6">
                            <h3 class="font-semibold text-lg mb-4 text-neutral-900 dark:text-white border-b border-neutral-100 dark:border-neutral-700 pb-2">
                                Внешний вид
                            </h3>
                            
                            <!-- Theme Toggle -->
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 shrink-0 rounded-xl bg-neutral-100 dark:bg-neutral-700 flex items-center justify-center text-neutral-600 dark:text-neutral-300">
                                        <i class="fa-solid fa-moon"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-neutral-900 dark:text-white">Темная тема</h3>
                                        <p class="text-sm text-neutral-500">Переключить оформление интерфейса</p>
                                    </div>
                                </div>
                                <button 
                                    @click="toggleTheme" 
                                    class="relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-neutral-900 cursor-pointer"
                                    :class="isDarkMode ? 'bg-primary' : 'bg-neutral-200'"
                                >
                                    <span 
                                        class="inline-block h-5 w-5 transform rounded-full bg-white transition-transform shadow-sm"
                                        :class="isDarkMode ? 'translate-x-6' : 'translate-x-1'"
                                    ></span>
                                </button>
                            </div>

                            <!-- Accent Color Picker -->
                            <div>
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="w-10 h-10 shrink-0 rounded-xl bg-neutral-100 dark:bg-neutral-700 flex items-center justify-center text-neutral-600 dark:text-neutral-300">
                                        <i class="fa-solid fa-palette"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-neutral-900 dark:text-white">Цвет акцента</h3>
                                        <p class="text-sm text-neutral-500">Выберите основной цвет приложения</p>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-4 pl-14 items-center">
                                    <!-- Presets -->
                                    <button 
                                        v-for="color in availableColors" 
                                        :key="color.value"
                                        @click="setAccentColor(color.value)"
                                        class="w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 focus:outline-none ring-2 ring-offset-2 dark:ring-offset-neutral-800 shadow-sm flex items-center justify-center"
                                        :class="[
                                            accentColor === color.value ? 'ring-neutral-400 dark:ring-neutral-500 scale-110' : 'ring-transparent'
                                        ]"
                                        :style="{ backgroundColor: color.value }"
                                        :title="color.name"
                                    >
                                        <i v-if="accentColor === color.value" class="fa-solid fa-check text-white text-xs drop-shadow-sm"></i>
                                    </button>

                                    <!-- Custom Color Trigger -->
                                    <div class="relative">
                                         <button 
                                            @click.stop="showColorInput = !showColorInput" 
                                            class="w-10 h-10 rounded-full bg-neutral-100 dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 flex items-center justify-center text-neutral-500 hover:text-neutral-800 dark:hover:text-white transition-colors cursor-pointer ring-2 ring-offset-2 dark:ring-offset-neutral-800 relative"
                                            :class="[
                                                showColorInput ? 'ring-primary text-primary' : 'ring-transparent',
                                                !availableColors.some(c => c.value === accentColor) ? 'ring-neutral-400 dark:ring-neutral-500' : ''
                                            ]"
                                            title="Свой цвет"
                                        >
                                            <i class="fa-solid fa-sliders"></i>
                                            <div v-if="!availableColors.some(c => c.value === accentColor)" class="absolute -top-1 -right-1 w-4 h-4 bg-primary text-white rounded-full flex items-center justify-center border-2 border-white dark:border-neutral-800">
                                                <i class="fa-solid fa-check text-[8px]"></i>
                                            </div>
                                        </button>
                                        
                                        <!-- Custom Color Popup (Sliders) -->
                                        <div 
                                            v-if="showColorInput" 
                                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-white dark:bg-neutral-800 p-4 rounded-xl shadow-xl border border-neutral-200 dark:border-neutral-600 z-20 w-64 animate-fade-in"
                                            @click.stop
                                        >
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Настройка цвета</label>
                                                <div class="w-6 h-6 rounded border border-neutral-200 dark:border-neutral-600 shadow-inner shrink-0 transition-colors duration-200" :style="{background: accentColor}"></div>
                                            </div>

                                            <div class="space-y-3">
                                                <!-- Hue -->
                                                <div>
                                                    <div class="flex justify-between text-[10px] text-neutral-400 mb-1">
                                                        <span>Оттенок</span>
                                                        <span>{{ hsl.h }}°</span>
                                                    </div>
                                                    <input 
                                                        type="range" 
                                                        min="0" max="360" 
                                                        v-model.number="hsl.h" 
                                                        @input="updateColorFromSliders"
                                                        class="w-full h-2 rounded-lg appearance-none cursor-pointer"
                                                        style="background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%);"
                                                    >
                                                </div>
                                                
                                                <!-- Saturation -->
                                                <div>
                                                    <div class="flex justify-between text-[10px] text-neutral-400 mb-1">
                                                        <span>Насыщенность</span>
                                                        <span>{{ hsl.s }}%</span>
                                                    </div>
                                                    <input 
                                                        type="range" 
                                                        min="0" max="100" 
                                                        v-model.number="hsl.s"
                                                        @input="updateColorFromSliders"
                                                        class="w-full h-2 bg-neutral-200 dark:bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-neutral-500"
                                                    >
                                                </div>

                                                <!-- Lightness -->
                                                <div>
                                                    <div class="flex justify-between text-[10px] text-neutral-400 mb-1">
                                                        <span>Яркость</span>
                                                        <span>{{ hsl.l }}%</span>
                                                    </div>
                                                    <input 
                                                        type="range" 
                                                        min="0" max="100" 
                                                        v-model.number="hsl.l"
                                                        @input="updateColorFromSliders"
                                                        class="w-full h-2 bg-neutral-200 dark:bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-neutral-500"
                                                    >
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Category Management -->
                        <div class="bg-white dark:bg-neutral-800 rounded-2xl p-6 shadow-sm border border-neutral-100 dark:border-neutral-700">
                            <h3 class="font-semibold text-lg mb-4 flex items-center text-neutral-900 dark:text-white border-b border-neutral-100 dark:border-neutral-700 pb-2">
                                <i class="fa-solid fa-tags mr-2 text-primary"></i> Категории
                            </h3>
                            
                            <!-- Add Category -->
                            <div class="flex space-x-2 mb-4">
                                <input 
                                    v-model="newCategoryName"
                                    type="text" 
                                    placeholder="Название новой категории"
                                    class="flex-1 px-4 py-2.5 rounded-xl bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 text-sm focus:ring-2 focus:ring-primary outline-none dark:text-white placeholder-neutral-400"
                                >
                                <button 
                                    @click="addCategory" 
                                    class="bg-primary hover:brightness-90 text-white px-5 py-2.5 rounded-xl transition-colors cursor-pointer shadow-md shadow-primary/20"
                                >
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>

                            <!-- Category List -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-2">
                                <div
                                    v-for="cat in categories"
                                    :key="cat.id"
                                    class="flex items-center justify-between p-2.5 rounded-xl border transition-all duration-200"
                                    :class="editingCategoryId === cat.id ? 'bg-white dark:bg-neutral-800 border-primary shadow-sm ring-1 ring-primary' : 'bg-neutral-50 dark:bg-neutral-900 border-transparent hover:border-neutral-200 dark:hover:border-neutral-700'"
                                >
                                    <div class="flex items-center gap-3 flex-1 min-w-0 mr-2">
                                        <i class="fa-solid fa-tag text-primary/50 w-5 text-center"></i>
                                        <span 
                                            v-if="editingCategoryId !== cat.id" 
                                            class="text-sm font-medium text-neutral-800 dark:text-neutral-200 block truncate"
                                        >{{ cat.name }}</span>
                                        <input 
                                            v-else 
                                            v-model="editingCategoryName" 
                                            @keyup.enter="saveCategoryEdit(cat)"
                                            @keyup.esc="editingCategoryId = null"
                                            placeholder="Название..."
                                            ref="editInput"
                                            class="bg-transparent border-none p-0 text-sm w-full outline-none text-neutral-900 dark:text-white font-medium placeholder-neutral-400"
                                        >
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 shrink-0">
                                        <template v-if="editingCategoryId !== cat.id">
                                            <button 
                                                @click="startCategoryEdit(cat)" 
                                                class="w-8 h-8 flex items-center justify-center rounded-lg text-neutral-400 hover:text-primary hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors cursor-pointer"
                                                title="Редактировать"
                                            >
                                                <i class="fa-solid fa-pen text-xs"></i>
                                            </button>
                                            <button 
                                                @click="confirmDeleteCategory(cat.id)" 
                                                class="w-8 h-8 flex items-center justify-center rounded-lg text-neutral-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors cursor-pointer"
                                                title="Удалить"
                                            >
                                                <i class="fa-solid fa-trash text-xs"></i>
                                            </button>
                                        </template>
                                        <template v-else>
                                            <button 
                                                @click="saveCategoryEdit(cat)" 
                                                class="w-8 h-8 flex items-center justify-center rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors cursor-pointer"
                                                title="Сохранить"
                                            >
                                                <i class="fa-solid fa-check text-xs"></i>
                                            </button>
                                            <button 
                                                @click="editingCategoryId = null" 
                                                class="w-8 h-8 flex items-center justify-center rounded-lg text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors cursor-pointer"
                                                title="Отмена"
                                            >
                                                <i class="fa-solid fa-xmark text-xs"></i>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="bg-white dark:bg-neutral-800 rounded-2xl p-6 shadow-sm border border-neutral-100 dark:border-neutral-700">
                            <h3 class="font-semibold text-lg mb-4 flex items-center text-neutral-900 dark:text-white border-b border-neutral-100 dark:border-neutral-700 pb-2">
                                <i class="fa-solid fa-database mr-2 text-primary"></i> Управление данными
                            </h3>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button 
                                    @click="exportData" 
                                    class="flex items-center justify-center space-x-2 py-3 bg-neutral-50 dark:bg-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-600 border border-neutral-200 dark:border-neutral-600 rounded-xl transition-colors text-sm font-medium text-neutral-700 dark:text-neutral-200 cursor-pointer"
                                >
                                    <i class="fa-solid fa-download text-neutral-500 dark:text-neutral-400"></i>
                                    <span>Экспорт</span>
                                </button>
                                <label class="flex items-center justify-center space-x-2 py-3 bg-neutral-50 dark:bg-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-600 border border-neutral-200 dark:border-neutral-600 rounded-xl transition-colors text-sm font-medium cursor-pointer text-neutral-700 dark:text-neutral-200">
                                    <i class="fa-solid fa-upload text-neutral-500 dark:text-neutral-400"></i>
                                    <span>Импорт</span>
                                    <input type="file" @change="importData" class="hidden" accept=".json">
                                </label>
                            </div>
                            <button 
                                @click="confirmClearAllData"
                                class="w-full flex items-center justify-center space-x-2 py-3 border border-red-200 dark:border-red-900/50 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors text-sm font-medium cursor-pointer"
                            >
                                <i class="fa-solid fa-trash-can"></i>
                                <span>Удалить все данные</span>
                            </button>
                        </div>
                        
                        <div class="text-center text-xs text-neutral-400 mt-8 pb-4">
                            Prompt Hub v1.2.0 &bull; SPA by Vue.js
                        </div>
                    </div>
                </div>
            </main>

            <!-- Mobile Bottom Navigation (Doc Bar) -->
            <nav class="md:hidden bg-white/90 dark:bg-neutral-800/90 backdrop-blur-lg border-t border-neutral-200 dark:border-neutral-700 fixed bottom-0 w-full z-20 pb-safe">
                <div class="flex justify-around items-center h-16 px-2">
                    <button 
                        @click="currentTab = 'home'"
                        class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative cursor-pointer"
                        :class="currentTab === 'home' ? 'text-primary' : 'text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300'"
                    >
                        <i class="fa-solid fa-house text-xl mb-0.5"></i>
                        <span class="text-[10px] font-medium">Главная</span>
                        <span v-if="currentTab === 'home'" class="absolute top-0 w-12 h-0.5 bg-primary rounded-b-full"></span>
                    </button>
                    
                    <button 
                        @click="currentTab = 'categories'"
                        class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative cursor-pointer"
                        :class="currentTab === 'categories' ? 'text-primary' : 'text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300'"
                    >
                        <i class="fa-solid fa-layer-group text-xl mb-0.5"></i>
                        <span class="text-[10px] font-medium">Категории</span>
                        <span v-if="currentTab === 'categories'" class="absolute top-0 w-12 h-0.5 bg-primary rounded-b-full"></span>
                    </button>
                    
                    <button 
                        @click="currentTab = 'settings'"
                        class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative cursor-pointer"
                        :class="currentTab === 'settings' ? 'text-primary' : 'text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300'"
                    >
                        <i class="fa-solid fa-gear text-xl mb-0.5"></i>
                        <span class="text-[10px] font-medium">Настройки</span>
                        <span v-if="currentTab === 'settings'" class="absolute top-0 w-12 h-0.5 bg-primary rounded-b-full"></span>
                    </button>
                </div>
            </nav>

            <!-- ADD PROMPT MODAL -->
            <transition name="fade">
                <div v-if="isAddPromptModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" @click.self="closeAddPromptModal">
                    <div class="modal-content bg-white dark:bg-neutral-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <!-- Header -->
                        <div class="px-6 py-4 border-b border-neutral-100 dark:border-neutral-700 flex justify-between items-center bg-neutral-50/50 dark:bg-neutral-900/50">
                            <h3 class="font-bold text-lg text-neutral-900 dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-plus-circle text-primary"></i>
                                Новый промпт
                            </h3>
                            <button @click="closeAddPromptModal" class="text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-200 transition-colors bg-neutral-200 dark:bg-neutral-700 rounded-full w-8 h-8 flex items-center justify-center cursor-pointer">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Form Body -->
                        <div class="p-6 overflow-y-auto flex-1">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-neutral-600 dark:text-neutral-400 mb-1.5">Заголовок</label>
                                    <input 
                                        v-model="newPrompt.title" 
                                        type="text" 
                                        placeholder="Название промпта" 
                                        class="w-full px-4 py-3 rounded-xl bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 focus:ring-2 focus:ring-primary outline-none dark:text-white placeholder-neutral-400"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-neutral-600 dark:text-neutral-400 mb-1.5">Категория</label>
                                    <div class="relative" ref="categoryDropdownRef">
                                        <button 
                                            type="button"
                                            @click="isCategoryDropdownOpen = !isCategoryDropdownOpen"
                                            class="w-full flex items-center justify-between gap-3 px-4 py-3.5 rounded-xl bg-white dark:bg-neutral-900 border-2 border-neutral-200 dark:border-neutral-600 focus:border-primary focus:outline-none outline-none text-left"
                                            :class="isCategoryDropdownOpen ? 'border-primary ring-2 ring-primary/20' : ''"
                                        >
                                            <span class="flex items-center gap-3 min-w-0">
                                                <i class="fa-solid fa-folder text-neutral-400 dark:text-neutral-500 shrink-0"></i>
                                                <span :class="newPrompt.categoryId ? 'text-neutral-900 dark:text-white font-medium' : 'text-neutral-400 dark:text-neutral-500'">
                                                    {{ newPrompt.categoryId ? getCategoryName(newPrompt.categoryId) : 'Выберите категорию' }}
                                                </span>
                                            </span>
                                            <i class="fa-solid fa-chevron-down text-neutral-400 shrink-0" :class="isCategoryDropdownOpen ? 'rotate-180' : ''"></i>
                                        </button>
                                        <div 
                                            v-if="isCategoryDropdownOpen" 
                                            class="absolute top-full left-0 right-0 mt-1.5 rounded-xl bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-600 shadow-xl z-50 max-h-52 overflow-y-auto overflow-x-hidden"
                                        >
                                                <button 
                                                    v-for="cat in categories" 
                                                    :key="cat.id"
                                                    type="button"
                                                    @click="newPrompt.categoryId = cat.id; isCategoryDropdownOpen = false"
                                                    class="w-full flex items-center gap-3 px-4 py-3 text-left cursor-pointer outline-none focus:outline-none first:rounded-t-lg last:rounded-b-lg"
                                                    :class="newPrompt.categoryId === cat.id ? 'bg-primary/10 text-primary dark:bg-primary/20' : 'text-neutral-700 dark:text-neutral-200'"
                                                >
                                                    <i class="fa-solid fa-folder w-5 text-center shrink-0" :class="newPrompt.categoryId === cat.id ? 'text-primary' : 'text-neutral-400 dark:text-neutral-500'"></i>
                                                    <span class="font-medium">{{ cat.name }}</span>
                                                    <i v-if="newPrompt.categoryId === cat.id" class="fa-solid fa-check ml-auto text-primary"></i>
                                                </button>
                                                <div v-if="categories.length === 0" class="px-4 py-6 text-center text-neutral-400 dark:text-neutral-500 text-sm">
                                                    Нет категорий
                                                </div>
                                            </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-neutral-600 dark:text-neutral-400 mb-1.5">Текст промпта</label>
                                    <textarea 
                                        v-model="newPrompt.text" 
                                        rows="6" 
                                        placeholder="Введите текст вашего промпта..." 
                                        class="w-full px-4 py-3 rounded-xl bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 focus:ring-2 focus:ring-primary outline-none resize-none dark:text-white placeholder-neutral-400"
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="p-4 border-t border-neutral-100 dark:border-neutral-700 bg-neutral-50/50 dark:bg-neutral-900/50 flex gap-3">
                            <button 
                                @click="closeAddPromptModal"
                                class="flex-1 py-3 px-4 rounded-xl border border-neutral-200 dark:border-neutral-700 text-neutral-600 dark:text-neutral-300 font-medium hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors cursor-pointer"
                            >
                                Отмена
                            </button>
                            <button 
                                @click="addPrompt"
                                class="flex-[2] py-3 px-4 rounded-xl bg-primary hover:brightness-90 text-white font-medium shadow-lg shadow-primary/30 active:scale-95 flex items-center justify-center gap-2 cursor-pointer"
                            >
                                <i class="fa-solid fa-save"></i> Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- PROMPT MODAL -->
            <transition name="fade">
                <div v-if="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="closeModal">
                    <div class="bg-white dark:bg-neutral-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all flex flex-col max-h-[85vh] animate-fade-in">
                        <!-- Header -->
                        <div class="px-6 py-4 border-b border-neutral-100 dark:border-neutral-700 flex justify-between items-center bg-neutral-50/50 dark:bg-neutral-900/50">
                            <h3 class="font-bold text-lg text-neutral-900 dark:text-white truncate pr-4">{{ selectedPrompt?.title }}</h3>
                            <button @click="closeModal" class="text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-200 transition-colors bg-neutral-200 dark:bg-neutral-700 rounded-full w-8 h-8 flex items-center justify-center cursor-pointer">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Body -->
                        <div class="p-6 overflow-y-auto bg-neutral-50 dark:bg-neutral-900/30">
                            <div class="bg-white dark:bg-neutral-800 p-5 rounded-xl border border-neutral-100 dark:border-neutral-700 shadow-sm relative group">
                                <p class="whitespace-pre-wrap text-neutral-700 dark:text-neutral-300 text-sm leading-relaxed font-mono">{{ selectedPrompt?.text }}</p>
                            </div>
                            <div class="mt-4 flex justify-between items-center text-xs text-neutral-400">
                                <span>Категория: {{ getCategoryName(selectedPrompt?.categoryId) }}</span>
                                <span>ID: {{ selectedPrompt?.id }}</span>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="p-4 border-t border-neutral-100 dark:border-neutral-700 bg-white dark:bg-neutral-800 flex space-x-3">
                            <button 
                                @click="confirmDeletePrompt(selectedPrompt.id)"
                                class="flex-1 py-3 px-4 rounded-xl border border-red-200 dark:border-red-900/50 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium transition-colors flex items-center justify-center cursor-pointer group"
                            >
                                <i class="fa-solid fa-trash mr-2 group-hover:scale-110 transition-transform"></i> Удалить
                            </button>
                            <button 
                                @click="copyToClipboard(selectedPrompt.text)"
                                class="flex-[2] py-3 px-4 rounded-xl bg-primary hover:brightness-90 text-white font-medium shadow-lg shadow-primary/30 active:scale-95 transition-all flex items-center justify-center cursor-pointer group"
                            >
                                <i class="fa-regular fa-copy mr-2 group-hover:scale-110 transition-transform"></i> Копировать
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- CONFIRMATION MODAL -->
            <transition name="fade">
                <div v-if="isConfirmModalOpen" class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="closeConfirmModal">
                    <div class="bg-white dark:bg-neutral-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 transform transition-all border border-neutral-100 dark:border-neutral-700 animate-fade-in">
                        <div class="text-center mb-6">
                            <div class="w-14 h-14 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-bold text-neutral-900 dark:text-white mb-2">{{ confirmModalState.title }}</h3>
                            <p class="text-sm text-neutral-500 dark:text-neutral-400">{{ confirmModalState.message }}</p>
                        </div>
                        <div class="flex space-x-3">
                            <button 
                                @click="closeConfirmModal"
                                class="flex-1 py-3 px-4 rounded-xl border border-neutral-200 dark:border-neutral-700 text-neutral-600 dark:text-neutral-300 font-medium hover:bg-neutral-50 dark:hover:bg-neutral-750 transition-colors cursor-pointer"
                            >
                                Отмена
                            </button>
                            <button 
                                @click="executeConfirmAction"
                                class="flex-1 py-3 px-4 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium shadow-lg shadow-red-500/30 active:scale-95 transition-all cursor-pointer"
                            >
                                Удалить
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- TOAST NOTIFICATIONS -->
            <transition-group 
                tag="div" 
                enter-active-class="transform ease-out duration-300 transition" 
                enter-from-class="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2" 
                enter-to-class="translate-y-0 opacity-100 sm:translate-x-0" 
                leave-active-class="transition ease-in duration-100" 
                leave-from-class="opacity-100" 
                leave-to-class="opacity-0"
                class="fixed top-4 right-4 z-[80] space-y-2 w-full max-w-xs pointer-events-none pr-4 pl-4 sm:pl-0"
            >
                <div 
                    v-for="toast in toasts" 
                    :key="toast.id"
                    class="pointer-events-auto w-full max-w-sm overflow-hidden rounded-xl shadow-lg ring-1 ring-black ring-opacity-5 flex items-center p-4 bg-white dark:bg-neutral-800 border-l-4"
                    :class="{
                        'border-green-500': toast.type === 'success',
                        'border-red-500': toast.type === 'error',
                        'border-blue-500': toast.type === 'info'
                    }"
                >
                    <div class="flex-shrink-0">
                        <i v-if="toast.type === 'success'" class="fa-solid fa-check-circle text-green-500 text-xl"></i>
                        <i v-else-if="toast.type === 'error'" class="fa-solid fa-exclamation-circle text-red-500 text-xl"></i>
                        <i v-else class="fa-solid fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-medium text-neutral-900 dark:text-neutral-100">{{ toast.message }}</p>
                    </div>
                </div>
            </transition-group>

        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- STATE ---
                const currentTab = ref('home');
                const isDarkMode = ref(false); 
                const searchQuery = ref('');
                const accentColor = ref('#2563eb');
                const showColorInput = ref(false);
                const hsl = ref({ h: 221, s: 83, l: 53 }); // Default Blue HSL

                const availableColors = [
                    { name: 'Синий', value: '#2563eb' },
                    { name: 'Фиолетовый', value: '#9333ea' },
                    { name: 'Зеленый', value: '#16a34a' },
                    { name: 'Красный', value: '#dc2626' },
                    { name: 'Оранжевый', value: '#ea580c' },
                ];
                
                // Data
                const categories = ref([
                    { id: 'cat_1', name: 'Работа' },
                    { id: 'cat_2', name: 'Обучение' },
                    { id: 'cat_3', name: 'Креатив' }
                ]);
                
                const prompts = ref([
                    { id: 1, title: 'Анализ SEO', text: 'Проведи SEO анализ текста: [текст]', categoryId: 'cat_1' },
                    { id: 2, title: 'Объясни код', text: 'Объясни, что делает этот код шаг за шагом: [код]', categoryId: 'cat_2' }
                ]);

                // Forms
                const newPrompt = ref({ title: '', text: '', categoryId: '' });
                const newCategoryName = ref('');
                const editingCategoryId = ref(null);
                const editingCategoryName = ref('');
                const editInput = ref(null);

                // UI State
                const expandedCategories = ref([]);
                const isModalOpen = ref(false);
                const isAddPromptModalOpen = ref(false);
                const isCategoryDropdownOpen = ref(false);
                const categoryDropdownRef = ref(null);
                const selectedPrompt = ref(null);
                const toasts = ref([]);
                let toastIdCounter = 0;

                // Confirmation Modal State
                const isConfirmModalOpen = ref(false);
                const confirmModalState = ref({ title: '', message: '' });
                const pendingConfirmAction = ref(null);

                // --- COMPUTED ---
                const filteredPrompts = computed(() => {
                    const query = searchQuery.value.toLowerCase().trim();
                    if (!query) return prompts.value.slice().reverse(); // Show newest first
                    
                    return prompts.value.filter(p => {
                        const catName = getCategoryName(p.categoryId).toLowerCase();
                        return p.title.toLowerCase().includes(query) || 
                               p.text.toLowerCase().includes(query) ||
                               catName.includes(query);
                    });
                });

                // --- METHODS ---

                // Persistence
                const saveData = () => {
                    localStorage.setItem('ph_prompts', JSON.stringify(prompts.value));
                    localStorage.setItem('ph_categories', JSON.stringify(categories.value));
                    localStorage.setItem('ph_theme', JSON.stringify(isDarkMode.value));
                    localStorage.setItem('ph_accent', accentColor.value);
                };

                const loadData = () => {
                    const savedPrompts = localStorage.getItem('ph_prompts');
                    const savedCategories = localStorage.getItem('ph_categories');
                    const savedTheme = localStorage.getItem('ph_theme');
                    const savedAccent = localStorage.getItem('ph_accent');

                    if (savedPrompts) prompts.value = JSON.parse(savedPrompts);
                    if (savedCategories) categories.value = JSON.parse(savedCategories);
                    if (savedTheme) isDarkMode.value = JSON.parse(savedTheme);
                    if (savedAccent) {
                        accentColor.value = savedAccent;
                        // Convert Hex to HSL for sliders initialization
                        updateHslFromHex(savedAccent);
                        updateAccentCss();
                    }
                };

                const updateAccentCss = () => {
                     document.documentElement.style.setProperty('--primary-color', accentColor.value);
                };

                const setAccentColor = (color) => {
                    accentColor.value = color;
                    updateHslFromHex(color);
                    updateAccentCss();
                    saveData();
                };

                // HSL to HEX helper
                const hslToHex = (h, s, l) => {
                    l /= 100;
                    const a = s * Math.min(l, 1 - l) / 100;
                    const f = n => {
                        const k = (n + h / 30) % 12;
                        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                        return Math.round(255 * color).toString(16).padStart(2, '0');
                    };
                    return `#${f(0)}${f(8)}${f(4)}`;
                };

                // HEX to HSL helper (simplified for primary colors)
                const updateHslFromHex = (hex) => {
                    let r = 0, g = 0, b = 0;
                    if (hex.length === 4) {
                        r = "0x" + hex[1] + hex[1];
                        g = "0x" + hex[2] + hex[2];
                        b = "0x" + hex[3] + hex[3];
                    } else if (hex.length === 7) {
                        r = "0x" + hex[1] + hex[2];
                        g = "0x" + hex[3] + hex[4];
                        b = "0x" + hex[5] + hex[6];
                    }
                    r /= 255; g /= 255; b /= 255;
                    let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin;
                    let h = 0, s = 0, l = 0;
                    if (delta === 0) h = 0;
                    else if (cmax === r) h = ((g - b) / delta) % 6;
                    else if (cmax === g) h = (b - r) / delta + 2;
                    else h = (r - g) / delta + 4;
                    h = Math.round(h * 60);
                    if (h < 0) h += 360;
                    l = (cmax + cmin) / 2;
                    s = delta === 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
                    s = +(s * 100).toFixed(1);
                    l = +(l * 100).toFixed(1);
                    
                    hsl.value = { h, s, l };
                };

                const updateColorFromSliders = () => {
                    accentColor.value = hslToHex(hsl.value.h, hsl.value.s, hsl.value.l);
                    updateAccentCss();
                    saveData();
                };

                // Confirmation Logic
                const askConfirm = (title, message, action) => {
                    confirmModalState.value = { title, message };
                    pendingConfirmAction.value = action;
                    isConfirmModalOpen.value = true;
                };

                const closeConfirmModal = () => {
                    isConfirmModalOpen.value = false;
                    setTimeout(() => {
                        pendingConfirmAction.value = null;
                    }, 300);
                };

                const executeConfirmAction = () => {
                    if (pendingConfirmAction.value) {
                        pendingConfirmAction.value();
                    }
                    closeConfirmModal();
                };

                // Prompts
                const closeAddPromptModal = () => {
                    isAddPromptModalOpen.value = false;
                    isCategoryDropdownOpen.value = false;
                    newPrompt.value = { title: '', text: '', categoryId: '' };
                };

                const addPrompt = () => {
                    if (!newPrompt.value.title || !newPrompt.value.text || !newPrompt.value.categoryId) {
                        showToast('Заполните все поля', 'error');
                        return;
                    }
                    
                    prompts.value.push({
                        id: Date.now(),
                        title: newPrompt.value.title,
                        text: newPrompt.value.text,
                        categoryId: newPrompt.value.categoryId
                    });
                    
                    closeAddPromptModal();
                    showToast('Промпт успешно добавлен!', 'success');
                    saveData();
                };

                const confirmDeletePrompt = (id) => {
                    askConfirm(
                        'Удаление промпта',
                        'Вы уверены, что хотите удалить этот промпт?',
                        () => deletePrompt(id)
                    );
                };

                const deletePrompt = (id) => {
                    prompts.value = prompts.value.filter(p => p.id !== id);
                    closeModal();
                    showToast('Промпт удален', 'info');
                    saveData();
                };

                const openPrompt = (prompt) => {
                    selectedPrompt.value = prompt;
                    isModalOpen.value = true;
                };

                const closeModal = () => {
                    isModalOpen.value = false;
                    setTimeout(() => selectedPrompt.value = null, 300);
                };

                // Categories
                const getCategoryName = (id) => {
                    const cat = categories.value.find(c => c.id === id);
                    return cat ? cat.name : 'Без категории';
                };

                const getPromptsByCategory = (catId) => {
                    return prompts.value.filter(p => p.categoryId === catId);
                };
                
                const getPromptsCount = (catId) => {
                    return prompts.value.filter(p => p.categoryId === catId).length;
                };

                const toggleCategory = (id) => {
                    // Logic for exclusive accordion: only one open at a time
                    if (expandedCategories.value.includes(id)) {
                        expandedCategories.value = [];
                    } else {
                        expandedCategories.value = [id];
                    }
                };

                const addCategory = () => {
                    if (!newCategoryName.value.trim()) return;
                    categories.value.push({
                        id: 'cat_' + Date.now(),
                        name: newCategoryName.value
                    });
                    newCategoryName.value = '';
                    showToast('Категория создана', 'success');
                    saveData();
                };

                const confirmDeleteCategory = (id) => {
                    const count = getPromptsCount(id);
                    if (count > 0) {
                        showToast(`Нельзя удалить категорию с ${count} промптами`, 'error');
                        return;
                    }
                    
                    askConfirm(
                        'Удаление категории',
                        'Удалить эту категорию?',
                        () => deleteCategory(id)
                    );
                };

                const deleteCategory = (id) => {
                    categories.value = categories.value.filter(c => c.id !== id);
                    saveData();
                    showToast('Категория удалена', 'info');
                };

                const startCategoryEdit = (cat) => {
                    editingCategoryId.value = cat.id;
                    editingCategoryName.value = cat.name;
                    nextTick(() => {
                        editInput.value?.focus();
                    });
                };

                const saveCategoryEdit = (cat) => {
                    if (editingCategoryName.value.trim()) {
                        cat.name = editingCategoryName.value;
                        editingCategoryId.value = null;
                        saveData();
                        showToast('Категория переименована', 'success');
                    }
                };

                // Utils
                const copyToClipboard = (text) => {
                    if (!navigator.clipboard) {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showToast('Скопировано в буфер!', 'success');
                        } catch (err) {
                            showToast('Ошибка копирования', 'error');
                        }
                        document.body.removeChild(textArea);
                        return;
                    }

                    closeModal();
                    
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Скопировано в буфер!', 'success');
                    }).catch(() => {
                        showToast('Ошибка копирования', 'error');
                    });
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    saveData();
                };

                const showToast = (message, type = 'info') => {
                    const id = toastIdCounter++;
                    toasts.value.push({ id, message, type });
                    setTimeout(() => {
                        toasts.value = toasts.value.filter(t => t.id !== id);
                    }, 3000);
                };

                // Import / Export
                const exportData = () => {
                    const data = {
                        prompts: prompts.value,
                        categories: categories.value,
                        version: 1
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `prompt-hub-backup-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Бэкап скачан', 'success');
                };

                const importData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.prompts && data.categories) {
                                prompts.value = data.prompts;
                                categories.value = data.categories;
                                saveData();
                                showToast('Данные успешно импортированы', 'success');
                            } else {
                                showToast('Неверный формат файла', 'error');
                            }
                        } catch (err) {
                            showToast('Ошибка чтения файла', 'error');
                        }
                    };
                    reader.readAsText(file);
                };

                const confirmClearAllData = () => {
                    askConfirm(
                        'Удалить всё?',
                        'Вы уверены, что хотите удалить ВСЕ данные (промпты и категории)? Это действие нельзя отменить.',
                        clearAllData
                    );
                };

                const clearAllData = () => {
                    prompts.value = [];
                    categories.value = [];
                    saveData();
                    showToast('Все данные успешно удалены', 'info');
                };

                // Watchers
                watch(isDarkMode, (val) => {
                    if (val) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
                
                watch(currentTab, () => {
                   // Scroll to top when changing tabs
                   document.querySelector('main').scrollTop = 0;
                });

                // Lifecycle
                onMounted(() => {
                    loadData();
                    if (isDarkMode.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                    updateAccentCss();
                    
                    // Close color picker and category dropdown on outside click
                    document.addEventListener('click', (e) => {
                        showColorInput.value = false;
                        if (isCategoryDropdownOpen.value && categoryDropdownRef.value && !categoryDropdownRef.value.contains(e.target)) {
                            isCategoryDropdownOpen.value = false;
                        }
                    });
                });

                return {
                    // State
                    currentTab,
                    isDarkMode,
                    searchQuery,
                    prompts,
                    categories,
                    newPrompt,
                    newCategoryName,
                    expandedCategories,
                    isModalOpen,
                    isAddPromptModalOpen,
                    isCategoryDropdownOpen,
                    categoryDropdownRef,
                    selectedPrompt,
                    toasts,
                    editingCategoryId,
                    editingCategoryName,
                    editInput,
                    accentColor,
                    availableColors,
                    showColorInput,
                    hsl,
                    updateColorFromSliders,
                    
                    // Confirmation State
                    isConfirmModalOpen,
                    confirmModalState,
                    
                    // Computed
                    filteredPrompts,
                    
                    // Methods
                    addPrompt,
                    confirmDeletePrompt,
                    openPrompt,
                    closeModal,
                    closeAddPromptModal,
                    getCategoryName,
                    getPromptsByCategory,
                    getPromptsCount,
                    toggleCategory,
                    addCategory,
                    confirmDeleteCategory,
                    startCategoryEdit,
                    saveCategoryEdit,
                    copyToClipboard,
                    toggleTheme,
                    exportData,
                    importData,
                    confirmClearAllData,
                    setAccentColor,
                    updateAccentCss,
                    saveData,
                    
                    // Confirmation Methods
                    closeConfirmModal,
                    executeConfirmAction
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
